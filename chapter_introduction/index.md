# 引言
:label:`chap_introduction`

在机器人开发的历史中，人们提出了多种中间件解决方案，引入了模块化和可适应的特性，以便使构建机器人系统变得更容易。随着时间的推移，一些中间件已经发展成为包含实用程序、算法和示例应用程序的丰富生态系统。很少有中间件在成熟机器人产业中的重要性能够与ROS 1相媲美。

ROS 1在几乎每个智能机器人领域都产生了影响。其商业崛起源于其提供的自主导航、仿真、可视化、控制等旗舰项目。随着商业机会转化为产品，ROS 作为研究平台的根基开始显示出其局限性。安全性、在非传统环境中的可靠性以及对大型嵌入式系统的支持成为推动行业前进的关键。许多公司正在ROS 1之上构建变通的解决方案，以创建更可靠的应用程序。

ROS 2，作为机器人操作系统的第二代产品，是彻底重新设计的，旨在解决原有挑战，并进一步发展其依赖社区力量的特性。ROS 2建立在数据分发服务（Data Distribution Service，DDS）之上，DDS是一种开放通信标准，广泛应用于军事、航天和金融等关键领域。它有效解决了构建可靠机器人系统时所面临的一系列问题。得益于DDS，ROS 2拥有了行业领先的安全性能、嵌入式和实时支持能力、多机器人通信功能，以及在不理想网络环境中的运行能力。在选择DDS之前，社区考虑了其他通信技术，如：ZeroMQ和RabbitMQ，最终选择了DDS，因为它具备包括UDP传输、分布式发现和内置安全标准等一系列全面的功能。

## ROS 2

ROS 2是一个用于开发机器人应用程序的软件平台，也被称为机器人软件开发套件（SDK）。重要的是，ROS 2是开源的。ROS 2在Apache 2.0许可证下分发，该许可证授予用户广泛的修改、应用和重新分发软件的权利，没有回馈义务。ROS 2依赖于开源生态系统，鼓励贡献者创建和发布他们自己的软件。大多数附加软件包也使用Apache 2.0许可证或类似的许可证。开源代码对于推动ROS 2的广泛采用至关重要，因为它允许用户自由地使用和分发他们的应用程序，不受任何限制。

### 范围

ROS 2 支持从教育、研究到产品开发和部署等多领域的机器人应用。这一框架包括众多相互依赖的软件组件，这些组件常用于开发机器人程序。整个软件环境可分为三大类：

  * 中间件：被称为“管道”，ROS 2的中间件负责处理组件间的通信，包括网络API和消息解析器等。
  * 算法：ROS 2提供了许多在构建机器人应用时常用的算法，例如：感知、SLAM、规划等。
  * 开发工具：ROS 2提供了一系列命令行和图形界面工具，包括用于配置、启动、内省、可视化、调试、仿真和日志记录的工具。同时，还有大量工具支持源代码管理、构建和分发。

中间件作为ROS2的基础，下面展开介绍。

### 设计

**1、设计理念**

ROS 2的设计遵循一系列原则和具体要求。以下是一些确立的设计原则：

  * 分布：在处理机器人技术这类复杂领域的问题时，最适合采用分布式系统的方法。需求被划分为多个功能独立的组件，如硬件的设备驱动程序、感知系统、控制系统等。运行时，这些组件各自拥有执行环境，并通过明确的通信方式共享数据。这种组件的组合应当以安全和去中心化的方式进行。
  * 抽象：为了有效管理通信，需要建立接口规范。这些规范明确了数据交换的语义。良好的抽象设计能在展示组件细节的好处与过度适配应用程序其他部分到该组件的成本之间找到平衡，避免因过度依赖而难以替换其他方案。这种方法促进了一个生态系统的形成，其中的组件可互操作，且独立于特定的硬件或软件供应商。
  * 异步：通过异步传递定义的消息，创建了一个基于事件的系统。采用这种方法，应用程序能够在多个时间域中运行，这些时间域是由物理设备与众多软件组件相结合产生的；每个组件可能都有自己的频率来提供数据、接受命令或发出事件信号。
  * 模块：UNIX的设计理念“每个程序专注于做好一件事”在这里得到了体现。模块化原则贯穿于各个层面，包括：库API、消息定义、命令行工具，以及整个软件生态系统。这个生态系统由众多独立而又相互协作的软件包组成，而不是单一的代码库。

我们不认为这些设计原则是普遍适用且无需权衡的。异步性有时也会让实现确定性的执行变得更加复杂。对于任何一个单独且明确界定的问题，理论上可以构建一个专用的、单一的整体解决方案，这种方案由于不涉及任何抽象概念或分布式通信，因此在计算效率上可能更高。

然而，基于十年的ROS 1项目经验，我们坚信坚持这些原则通常能带来更优的成果。这种方法有助于代码重用、软件测试、故障隔离，以及跨学科项目团队之间的合作，同时也促进了全球范围内的协作。

**2、设计要求**

ROS 2旨在满足基于机器人开发者的设计原则和需求而确定的一系列要求。

  * 安全：任何与网络交互的软件都必须具备保护这种交互不受意外或恶意使用的安全功能。ROS 2的内置安全系统涵盖了认证、数据加密和访问控制等方面。通过设定访问控制策略，设计者可以自定义谁有权就哪些内容进行通信，以满足特定的安全需求。
  * 嵌入式系统：通常情况下，机器人由传感器、执行器以及其他外围设备组成。这些设备可能较为复杂，包含需要与运行ROS 2的CPU（或CPUs）进行通信的微控制器。虽然小型嵌入式设备上并不需要运行完整的ROS 2系统，但ROS 2应当能够促进并统一CPU与微控制器的集成过程。Micro-ROS使得ROS 2能够在嵌入式系统中得以应用。
  * 多样化网络：机器人被广泛应用于各种网络环境，包括用于工业机械臂的有线局域网，以及为行星漫游车提供的多跳卫星连接。此外，机器人还常常利用内部网络，连接同一CPU内部以及跨CPU的进程。ROS 2提供服务质量（Quality of Service）配置，控制数据如何通过系统流动，从而适应网络的限制。
  * 实时计算：从人形机器人到自动驾驶汽车，机器人应用通常要求进行实时计算。为了达到安全标准或性能目标，系统的某些部分需要在可预测且一致的时间内完成执行。ROS 2提供了API，让开发实时系统的工程师能够根据具体的应用需求设定和执行相应的约束。
  * 产品就绪：当机器人从实验室应用到商业领域时，会面临更多新的限制和挑战。ROS 2的目标是满足产品设计、开发和项目管理的各种要求。这些努力的一个直接成果是，Apex.AI公司基于ROS 2开发的自动驾驶软件获得了功能安全（ISO 26262）认证。这意味着ROS 2现在可以被应用于像自动驾驶汽车和重型机械这样的安全关键系统中。

### 通信模式

ROS 2 API提供了访问多种通信机制。这些机制主要包括主题（Topics）、服务（Services）和动作（Actions），它们均以节点（Node）的概念为核心进行组织。此外，ROS 2还提供了参数（Parameters）、定时器（Timers）、启动（Launch）以及其他辅助功能API，这些工具可用于设计机器人系统。

  * 主题：用户最常使用的通信模式是主题，这是一种实现异步消息传递框架。它与其它异步框架（如 ASIO）相似。ROS 2提供了发布-订阅功能，但特别强调使用异步消息传递来组织系统，并采用强类型接口。这通过在计算图中以节点的形式组织终点来实现。节点作为一个关键的组织单元，使用户能够理解和推理复杂的系统结构，如 :numref:`fig_node_interfaces` 所示。匿名发布-订阅架构支持多方之间的通信，这对于监控系统内部活动非常有利。开发者可以通过简单地订阅某个主题，而无需对系统做任何修改，就能观察到该主题上传递的所有消息。
  * 服务：异步通信并非总是最佳选择。ROS 2还提供了一种基于请求-响应的通信模式，即“服务”。这种通信方式便于在请求和响应之间建立数据关联，有助于确认任务已完成或已接收，如 :numref:`fig_node_interfaces` 所示。特别的是，ROS 2实现了服务客户端在调用过程中的非阻塞特性。此外，服务按照节点进行组织，便于进行自我检查或系统分析，使子系统的接口能在系统诊断中集中展示。
  * 动作：ROS 2的一种独特通信模式是“动作”。这种模式以实现特定目标为核心，采用异步通信方式，包括发起请求、接收响应、周期性反馈以及具备可取消操作的功能，如 :numref:`fig_node_interfaces` 所示。动作模式适用于长时间执行的任务，例如自主导航或机械操作，同时也适用于多种其他场景。与“服务”类似，动作允许非阻塞操作，并且被安排在节点架构之下进行管理。

![ROS 2节点接口：主题，服务和动作](../img/node_interfaces.png)
:label:`fig_node_interfaces`

