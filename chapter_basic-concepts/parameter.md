# 参数服务器详述
:label:`sec_parameter`

参数服务器（Parameter Server）是一个用于存储和检索参数的分布式系统。参数服务器允许节点在运行时动态地共享和访问配置信息，如硬件设置、算法参数、系统配置等。与ROS 1中的集中式参数服务器不同，ROS 2的参数服务器是分布式系统的一个组成部分，这意味着参数的存储和检索是在节点本地进行的，但参数的更改会通过DDS传播到所有订阅了相应参数的节点。

参数服务器存储了键值对，其中键是一个唯一的字符串，值可以是任何支持的数据类型，如整数、浮点数、字符串、列表、字典等。每个节点都可以在其本地存储参数，并可以通过网络与其他节点的参数进行同步。

节点可以设置（set）、获取（get）和删除（delete）参数。参数操作通常用于节点启动时加载配置，或者在运行时根据某些条件动态调整配置。节点可以注册参数事件监听器，以便在参数更改时收到通知。参数事件监听器允许节点响应参数的动态变化，例如更新内部状态或重新配置系统。参数的更改会通过DDS传播到所有订阅了相应参数的节点。

参数服务器支持层级结构的参数名，这允许在逻辑上组织参数，例如将相关的参数分组到共同的命名空间下。参数可以具有不同的生命周期，例如有些参数可能在节点启动时设置一次，而其他参数可能会频繁更改。参数服务器支持不同的QoS设置，以控制参数通信的可靠性、持久性和实时性。每个节点会在其本地存储参数的副本，这样可以减少对网络的依赖，并提高访问速度。

参数服务器为机器人系统提供了一种强大的配置和管理工具。它允许开发者轻松地部署和维护复杂的机器人系统，同时确保了系统配置的灵活性和一致性。通过这种方式，开发者可以更专注于实现机器人的功能和行为，而不是处理配置和管理的问题。

## 概述

ROS 2 中的参数属于各个节点。它们用于在节点启动时以及运行期间进行配置，无需更改代码。参数的生命周期依赖于节点的生命周期（尽管节点可以实现某种形式的持久化，以便在重启后重新加载值）。

参数通过节点名称、节点命名空间、参数名称和参数命名空间来寻址。提供参数命名空间是可选的。

每个参数由一个键、一个值和一个描述符组成。键是一个字符串，而值可以是布尔值、64位整数、64位浮点数、字符串、字节数组、布尔数组、64位整数数组、64位浮点数数组或字符串数组中的一种。一般来说，所有描述符都是空的，但它们可以包含参数描述、值范围、类型信息以及附加约束。

通常情况下，节点需要定义在其生命周期内能接受的所有参数。这样做是为了在节点启动时清晰定义参数的类型和名称，从而减少后续配置错误的风险。对于某些类型的节点，可能无法提前预知所有参数。在这种情况下，创建节点实例时可以将``allow_undeclared_parameters``设置为``true``，这样即使未定义的参数也能在节点上进行获取和设置。

ROS 2节点上的每个参数都是上面提到的预设的参数类型之一。通常情况下，在运行时尝试改变已声明参数的类型将会失败，这避免了将布尔值放入整数参数等常见错误。如果某个参数需要能够是多种不同的类型，并且相应的代码能够处理这种情况，可以通过在声明参数时使用``ParameterDescriptor``并将``dynamic_typing``成员变量设置为``true``来改变这一默认行为。

ROS 2 节点可以设置两种不同类型的回调，以便在参数发生变更时得到通知。这两种回调都是可选的。

第一种是“set parameter”类型的回调，可以通过调用节点API中的``add_on_set_parameters_callback``来设置。该回调接收一个不可变的``Parameter``对象数组，并返回一个``rcl_interfaces/msg/SetParametersResult``。这个回调的主要目的是让用户能够审查即将发生的参数更改，并在必要时明确拒绝这些更改。

第二种类型的回调是“on parameter event”类型的回调，可以通过调用参数客户端API中的``on_parameter_event``来设置。该回调接收一个``rcl_interfaces/msg/ParameterEvent``对象，但不返回任何结果。此回调将在输入事件中的所有参数声明、更改或删除操作完成后被调用。这个回调的主要目的是让用户能够响应那些已成功更新的参数。

